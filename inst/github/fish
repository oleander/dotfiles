#!/bin/bash

set -x
set -e

# Check if fish is already installed
if command -v fish &> /dev/null; then
    echo "fish is already installed"
    exit 0
fi

# Check if we're in a Codespaces environment
if [ -n "$CODESPACES" ]; then
    echo "Running in GitHub Codespaces environment"
    # In Codespaces, we might not have sudo access or it might not be needed
    if command -v sudo &> /dev/null; then
        sudo apt-get update
        sudo apt-get install -y --no-install-recommends fish
    else
        echo "Cannot install fish without sudo access"
        exit 1
    fi
else
    # Non-Codespaces environment
    sudo apt-get update
    sudo apt-get install -y --no-install-recommends fish
fi

# Add fish to /etc/shells if not already there
if ! grep -q "$(which fish)" /etc/shells; then
    if command -v sudo &> /dev/null; then
        echo "$(which fish)" | sudo tee -a /etc/shells
    fi
fi

# Create fish config directory if it doesn't exist
mkdir -p ~/.config/fish/functions
mkdir -p ~/.config/fish/completions

# Install Fisher plugin manager if needed
if [ ! -f ~/.config/fish/functions/fisher.fish ]; then
    echo "Installing Fisher plugin manager"
    fish -c "curl -sL https://raw.githubusercontent.com/jorgebucaran/fisher/main/functions/fisher.fish | source && fisher install jorgebucaran/fisher"

    # Install plugins from fish_plugins file if it exists
    if [ -f ~/.config/fish/fish_plugins ]; then
        echo "Installing fish plugins..."
        fish -c "fisher update"
    fi
fi

# Set fish as default shell if it's not already
if [ "$SHELL" != "/usr/bin/fish" ]; then
    echo "Setting fish as default shell"
    command -v fish | sudo tee -a /etc/shells
    chsh -s $(command -v fish)
fi

echo "Fish shell installation complete!"
