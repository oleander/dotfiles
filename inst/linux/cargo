#!/bin/bash -e

# Check if cargo is already installed
if command -v cargo &>/dev/null; then
  echo "cargo is already installed"
  exit 0
fi

# Try to install using apk if available (for Alpine Linux)
if command -v apk &>/dev/null; then
  echo "Installing cargo using apk..."
  apk add --no-cache cargo
elif command -v apt-get &>/dev/null; then
  echo "Installing rustup using apt..."
  apt-get update && apt-get install -y curl gcc
  curl https://sh.rustup.rs -sSf | sh -s -- -y --profile minimal --default-toolchain stable
else
  echo "Installing rustup directly..."
  # Set environment variables to handle TLS warnings
  export RUSTUP_UPDATE_ROOT=https://static.rust-lang.org/rustup
  export RUSTUP_INIT_SKIP_PATH_CHECK=yes

  # Download and run the rustup installer with TLS settings
  curl https://sh.rustup.rs -sSf | RUSTUP_USE_CURL=1 sh -s -- -y --profile minimal --default-toolchain stable
fi

# Add cargo to the current shell session
export PATH="$HOME/.cargo/bin:$PATH"
source "$HOME/.cargo/env" 2>/dev/null || true

# Verify installation
if command -v cargo &>/dev/null; then
  echo "cargo installed successfully"
else
  echo "cargo installation failed"
  exit 1
fi
