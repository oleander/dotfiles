#!/usr/bin/env fish

function die
    echo -n (set_color red)"Error:"(set_color normal)" $argv" >&2
    echo "" >&2
    exit 1
end

# ensure we're in a Git repo
if not git rev-parse --is-inside-work-tree >/dev/null 2>&1
    die "Not a git repository."
end

# retrieve author email, or bail
function author_email
    set -l email (git config user.email 2>/dev/null)
    if test -z "$email"
        die "git user.email is not set"
    end
    echo $email
end

# pick the very next commit on first-parent ancestry by this author,
# skipping any bot-tagged ("ğŸ¤–") commits
function commit_message
    git log \
        --author="$email" \
        --format="%s" \
        --no-merges \
        --remove-empty \
        --invert-grep --grep='ğŸ¤–' | shuf -n 1 | string trim
end

# if there's nothing to commit, warn and exit
if test -z "$(git status --porcelain)"
    echo (set_color yellow)"Warning:"(set_color normal)" No changes to commit" >&2
    exit 0
end

# finally, stage and commit
set -l msg (commit_message)
git add .
exec git commit -m "$msg ğŸ¤–"
